{% extends 'base.html' %}
{% load static %}

{% block content %}
<header class="masthead my-20">
    <div class="text-center">
        <h1 class="section-heading text-uppercase">MÚSICA</h1>
    </div>
</header>

<div class="container my-4">
    <div class="list-group list-group-flush">
        {% for cancion in canciones %}
        <!-- Cada bloque es clicable para abrir el detalle de la canción -->
        <div class="row list-group-item align-items-center text-start"
             style="cursor: pointer;"
             onclick="mostrarDetalleCancion({{ cancion.id }}, '{{ cancion.archivo_audio.url }}')">
            <div class="col-3 col-lg-1">
                {% if cancion.album and cancion.album.portada %}
                  <img src="{{ cancion.album.portada.url }}" class="img-fluid rounded-2" alt="{{ cancion.album.titulo }}">
                {% else %}
                  <img src="{% static 'assets/img/default_album.png' %}" class="img-fluid rounded-2" alt="Imagen predeterminada">
                {% endif %}
            </div>

            <div class="col-7 col-lg-3">
                <div class="fw-bold">{{ cancion.titulo }}</div>
                <div>{{ cancion.artista.nombre }}</div>
            </div>

            <div class="col-lg-2 d-none d-lg-block">
                {{ cancion.categoria }}
            </div>

            <div class="col-lg-2 d-none d-lg-block">
                {% if cancion.album %}
                  {{ cancion.album.titulo }}
                {% else %}
                  Sin álbum
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal que hará de 'card' emergente para mostrar el detalle -->
<div class="modal fade" id="cancionModal" tabindex="-1" aria-labelledby="cancionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Cabecera del modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="cancionModalLabel">Detalle de la canción</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <!-- Cuerpo del modal -->
      <div class="modal-body">
        <img id="modal-imagen" src="{% static 'assets/img/default_album.png' %}" class="img-fluid mb-3" alt="Portada" />
        <h4 id="modal-titulo" class="fw-bold"></h4>
        <p id="modal-artista"></p>
        <audio id="modal-audio" controls class="w-100">
          Tu navegador no soporta el elemento <code>audio</code>.
        </audio>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para mostrar el detalle de la canción en el modal
function mostrarDetalleCancion(cancionId, audioUrl) {
    // Petición al backend para obtener más info de la canción
    fetch(`/musica/detalle/${cancionId}/`)
      .then(response => response.json())
      .then(data => {
          // Rellenar campos del modal
          document.getElementById('modal-titulo').textContent = data.titulo;
          document.getElementById('modal-artista').textContent = data.artista;
          document.getElementById('modal-imagen').src = data.imagen;
          document.getElementById('modal-audio').src = audioUrl;

          // Mostrar modal (asumiendo que usas Bootstrap 5)
          let modal = new bootstrap.Modal(document.getElementById('cancionModal'));
          modal.show();
      })
      .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
